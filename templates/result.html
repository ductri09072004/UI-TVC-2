{% extends "base.html" %}
{% block content %}
  {% if error %}
    <div class="card p-6 border-red-200 dark:border-red-800">
      <h4 class="text-xl font-semibold text-red-600 mb-2">L·ªói x·ª≠ l√Ω</h4>
      <p class="text-slate-700 dark:text-slate-200">{{ error }}</p>
      <div class="mt-4">
        <a href="{{ url_for('index') }}" class="btn-secondary">‚Üê V·ªÅ trang t·∫£i l√™n</a>
      </div>
    </div>
  {% else %}
    {% if regenerate_status and regenerate_status.state == 'processing' %}
    <div class="card p-4 mb-6 border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-900/20">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
        <div>
          <div class="font-semibold text-blue-700 dark:text-blue-300">ƒêang t·∫°o l·∫°i m√¥ t·∫£...</div>
          <div class="text-sm text-blue-600 dark:text-blue-400">{{ regenerate_status.message or 'Vui l√≤ng ƒë·ª£i, ƒëang x·ª≠ l√Ω c√°c frame...' }}</div>
        </div>
      </div>
      <div class="mt-2 text-xs text-blue-600 dark:text-blue-400">Trang s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi ho√†n t·∫•t. B·∫°n c√≥ th·ªÉ refresh trang ƒë·ªÉ ki·ªÉm tra.</div>
    </div>
    {% elif regenerate_status and regenerate_status.state == 'error' %}
    <div class="card p-4 mb-6 border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20">
      <div class="font-semibold text-red-700 dark:text-red-300">L·ªói khi t·∫°o l·∫°i m√¥ t·∫£</div>
      <div class="text-sm text-red-600 dark:text-red-400 mt-1">{{ regenerate_status.message or 'C√≥ l·ªói x·∫£y ra' }}</div>
    </div>
    {% endif %}
    
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <div class="text-sm text-slate-500">M√£ phi√™n</div>
        <div class="text-xl font-semibold tracking-tight">{{ job_id }}</div>
        <div class="text-xs text-slate-500 mt-1">T·ªïng ·∫£nh: {{ frames|length }}</div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <a href="{{ url_for('index') }}" class="btn-secondary">‚Üê T·∫£i video kh√°c</a>
        <a href="/web_outputs/{{ job_id }}/result.json" class="btn-primary" download>TaÃâi JSON</a>
        {% if frames and frames[0].get('caption') %}
        <form method="post" action="{{ url_for('label_job', job_id=job_id) }}" class="inline">
          <input type="hidden" name="clf_dir" value="{{ ("../TVC-AI/output_moderation") }}" />
          <button class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500" type="submit">G√°n nh√£n caption</button>
        </form>
        <button onclick="document.getElementById('regenerateModal').classList.remove('hidden')" class="inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" type="button">üîÑ T·∫°o l·∫°i m√¥ t·∫£</button>
        {% endif %}
      </div>
    </div>

    {# Summary block (after labeling) #}
    {% if summary %}
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="card p-4">
          <div class="text-sm text-slate-500">Khung h√¨nh ƒë·∫°t chu·∫©n</div>
          <div class="text-2xl font-semibold text-emerald-600">{{ summary.num_compliant }}<span class="text-base text-slate-400"> ({{ '%.2f'|format(summary.percent_compliant) }}%)</span></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-500">Khung h√¨nh vi ph·∫°m</div>
          <div class="text-2xl font-semibold text-red-600">{{ summary.num_violations }}<span class="text-base text-slate-400"> ({{ '%.2f'|format(summary.percent_violations) }}%)</span></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-500">T·ªïng khung h√¨nh</div>
          <div class="text-2xl font-semibold">{{ summary.total_frames }}</div>
          {% if summary.num_unknown and summary.num_unknown > 0 %}
            <div class="text-xs text-slate-500 mt-1">Kh√¥ng x√°c ƒë·ªãnh: {{ summary.num_unknown }}</div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {# Audio summary (if available) #}
    {% if audio_summary %}
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="card p-4">
          <div class="text-sm text-slate-500">ƒêo·∫°n tho·∫°i ƒë·∫°t chu·∫©n</div>
          <div class="text-2xl font-semibold text-emerald-600">{{ audio_summary.num_compliant }}<span class="text-base text-slate-400"> ({{ '%.2f'|format(audio_summary.percent_compliant) }}%)</span></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-500">ƒêo·∫°n tho·∫°i vi ph·∫°m</div>
          <div class="text-2xl font-semibold text-red-600">{{ audio_summary.num_violations }}<span class="text-base text-slate-400"> ({{ '%.2f'|format(audio_summary.percent_violations) }}%)</span></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-slate-500">T·ªïng ƒëo·∫°n tho·∫°i</div>
          <div class="text-2xl font-semibold">{{ audio_summary.total_segments }}</div>
          {% if audio_summary.num_unknown and audio_summary.num_unknown > 0 %}
            <div class="text-xs text-slate-500 mt-1">Kh√¥ng x√°c ƒë·ªãnh: {{ audio_summary.num_unknown }}</div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if audio_segments %}
      {# Old segment-based view kept for backward compatibility #}
    {% endif %}

    {% if audio_sentences %}
      <div class="card p-6 mb-6">
        <h4 class="text-lg font-semibold mb-3">Transcript √¢m thanh (theo c√¢u)</h4>
        <div class="space-y-2">
          {% for s in audio_sentences %}
            <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-3">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-500">C√¢u {{ s.index }}</span>
                {% if s.label_id is not none %}
                  {% if s.label_id == 1 %}
                    <span class="inline-flex items-center rounded-full bg-red-100 text-red-700 px-2 py-0.5 text-xs font-semibold">VI PH·∫†M</span>
                  {% elif s.label_id == 0 %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-2 py-0.5 text-xs font-semibold">ƒê·∫†T CHU·∫®N</span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full bg-slate-200 text-slate-700 px-2 py-0.5 text-xs font-semibold">KH√îNG R√ï</span>
                  {% endif %}
                {% endif %}
              </div>
              <div class="text-sm text-slate-700 dark:text-slate-200">{{ s.text }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# Detect if captions are missing (first frame no caption) #}
    {% set has_caption = frames and frames[0].get('caption') %}
    {% if not has_caption %}
      <div class="card p-6 mb-6">
        <h4 class="text-lg font-semibold mb-2">T·∫°o m√¥ t·∫£ cho c√°c ·∫£nh</h4>
        <p class="text-sm text-slate-500 mb-4">Hi·ªán t·∫°i m·ªõi tr√≠ch xu·∫•t ·∫£nh. B·∫°n c√≥ th·ªÉ t·∫°o m√¥ t·∫£ (caption) ngay b√¢y gi·ªù.</p>
        <form method="post" action="{{ url_for('caption_job', job_id=job_id) }}" class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="label" for="hf_model">Model t·∫°o m√¥ t·∫£</label>
            <select id="hf_model" name="hf_model" class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-base text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="Salesforce/blip-image-captioning-base" selected>BLIP Base (Nhanh, ~1GB)</option>
            </select>
          </div>
          
          <div>
            <label class="label" for="language">Ng√¥n ng·ªØ</label>
            <select id="language" name="language" class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-base text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="vi">Ti·∫øng Vi·ªát (vi)</option>
              <option value="en" selected>English (en)</option>
            </select>
          </div>
          
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="translate" class="checkbox" />
            <span class="text-sm">D·ªãch sang ng√¥n ng·ªØ ƒë√≠ch</span>
          </label>
          
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="use_object_detection" class="checkbox" />
            <span class="text-sm">S·ª≠ d·ª•ng YOLO ph√°t hi·ªán ƒë·ªëi t∆∞·ª£ng</span>
          </label>
          
          <div class="flex gap-3 sm:col-span-2">
            <button class="inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-6 py-3 text-base font-semibold text-white shadow hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500" type="submit">T·∫°o m√¥ t·∫£ ngay</button>
          </div>
        </form>
      </div>
    {% endif %}

    {% if frames|length == 0 %}
      <div class="card p-6">
        <p>Kh√¥ng c√≥ khung h√¨nh n√†o ƒë∆∞·ª£c tr√≠ch xu·∫•t.</p>
      </div>
    {% else %}
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5">
        {% for f in frames %}
          <div class="card overflow-hidden hover:shadow-lg transition-shadow" id="frame-{{ f.second }}">
            <div class="aspect-video bg-slate-100 dark:bg-slate-800">
              <img class="w-full h-full object-cover" src="{{ url_for('serve_frame', job_id=job_id, filename=f.image_rel.split('/')[-1]) }}" alt="frame" loading="lazy">
            </div>
            <div class="p-4">
              <div class="flex items-center justify-between mb-2 gap-2">
                <span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200 px-2 py-1 text-xs font-medium">Gi√¢y {{ f.second }}</span>
                {% if f.moderation %}
                  {% set v = f.moderation.verdict %}
                  {% if v == 'block' %}
                    <span class="inline-flex items-center rounded-full bg-red-100 text-red-700 px-2 py-1 text-xs font-semibold">BLOCK</span>
                  {% elif v == 'restricted' %}
                    <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-2 py-1 text-xs font-semibold">RESTRICTED</span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-2 py-1 text-xs font-semibold">ALLOW</span>
                  {% endif %}
                {% endif %}
              </div>
              <p class="text-sm text-slate-700 dark:text-slate-200">{{ f.caption }}</p>
              {% if f.get('clip_label') %}
                <div class="mt-2 flex items-center gap-2">
                  <span class="inline-flex items-center rounded-full bg-indigo-50 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200 px-2 py-1 text-xs font-medium">CLIP: {{ f.get('clip_label') }}</span>
                  {% if f.get('clip_label_score') is not none %}
                    <span class="text-xs text-slate-500">score: {{ '%.2f'|format(f.get('clip_label_score')) }}</span>
                  {% endif %}
                </div>
              {% endif %}
              {% if f.get('label_id') is not none %}
                <div class="mt-2 flex items-center gap-2">
                  <span class="inline-flex items-center rounded-full bg-emerald-50 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200 px-2 py-1 text-xs font-medium">Nh√£n: {{ f.get('label_id') }}</span>
                  {% if f.get('label_score') is not none %}
                    <span class="text-xs text-slate-500">score: {{ '%.2f'|format(f.get('label_score')) }}</span>
                  {% endif %}
                </div>
              {% endif %}
              {% if f.moderation and (f.moderation.categories or f.moderation.labels) %}
                <div class="mt-2 flex flex-wrap gap-2">
                  {% if f.moderation.categories %}
                    {% for cat in f.moderation.categories %}
                      <span class="inline-flex items-center rounded bg-slate-200 dark:bg-slate-700 px-2 py-0.5 text-[11px] uppercase tracking-wide">{{ cat }}</span>
                    {% endfor %}
                  {% else %}
                    {% for label in f.moderation.labels %}
                      <span class="inline-flex items-center rounded bg-slate-200 dark:bg-slate-700 px-2 py-0.5 text-[11px] uppercase tracking-wide">{{ label }}</span>
                    {% endfor %}
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {# Modal cho form t·∫°o l·∫°i m√¥ t·∫£ #}
    {% if frames and frames[0].get('caption') %}
    <div id="regenerateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="card p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">T·∫°o l·∫°i m√¥ t·∫£</h3>
          <button onclick="document.getElementById('regenerateModal').classList.add('hidden')" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <p class="text-sm text-slate-500 mb-4">T·∫°o l·∫°i m√¥ t·∫£ cho t·∫•t c·∫£ c√°c frame. M√¥ t·∫£ c≈© s·∫Ω b·ªã thay th·∫ø.</p>
        <form method="post" action="{{ url_for('regenerate_job', job_id=job_id) }}" class="grid sm:grid-cols-2 gap-4" onsubmit="document.getElementById('regenerateModal').classList.add('hidden')">
          <div>
            <label class="label" for="regenerate_hf_model">Model t·∫°o m√¥ t·∫£</label>
            <select id="regenerate_hf_model" name="hf_model" class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-base text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="Salesforce/blip-image-captioning-base" selected>BLIP Base (Nhanh, ~1GB)</option>
            </select>
          </div>
          
          <div>
            <label class="label" for="regenerate_language">Ng√¥n ng·ªØ</label>
            <select id="regenerate_language" name="language" class="block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-base text-slate-900 dark:text-slate-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="vi">Ti·∫øng Vi·ªát (vi)</option>
              <option value="en" selected>English (en)</option>
            </select>
          </div>
          
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="translate" class="checkbox" />
            <span class="text-sm">D·ªãch sang ng√¥n ng·ªØ ƒë√≠ch</span>
          </label>
          
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="use_object_detection" class="checkbox" />
            <span class="text-sm">S·ª≠ d·ª•ng YOLO ph√°t hi·ªán ƒë·ªëi t∆∞·ª£ng</span>
          </label>
          
          <div class="flex gap-3 sm:col-span-2">
            <button class="inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-6 py-3 text-base font-semibold text-white shadow hover:bg-blue-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500" type="submit">X√°c nh·∫≠n t·∫°o l·∫°i</button>
            <button onclick="document.getElementById('regenerateModal').classList.add('hidden')" type="button" class="inline-flex items-center justify-center gap-2 rounded-xl bg-slate-200 dark:bg-slate-700 px-6 py-3 text-base font-semibold text-slate-800 dark:text-slate-100 hover:bg-slate-300 dark:hover:bg-slate-600">H·ªßy</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}
  {% endif %}

  <script>
    // Auto-check regenerate status n·∫øu ƒëang processing
    {% if regenerate_status and regenerate_status.state == 'processing' %}
    let checkInterval = null;
    let checkCount = 0;
    const MAX_CHECKS = 300; // T·ªëi ƒëa 5 ph√∫t (300 * 1 gi√¢y)
    
    function checkRegenerateStatus() {
      checkCount++;
      if (checkCount > MAX_CHECKS) {
        clearInterval(checkInterval);
        console.log('ƒê√£ v∆∞·ª£t qu√° th·ªùi gian ch·ªù, d·ª´ng ki·ªÉm tra');
        return;
      }
      
      fetch('{{ url_for("regenerate_status_api", job_id=job_id) }}')
      .then(response => response.json())
      .then(status => {
        if (status.state === 'done' || status.state === 'error' || status.state === 'none') {
          // ƒê√£ xong ho·∫∑c l·ªói, d·ª´ng check v√† reload trang
          clearInterval(checkInterval);
          window.location.reload();
        }
        // N·∫øu v·∫´n processing, ti·∫øp t·ª•c check
      })
      .catch(error => {
        console.error('Error checking status:', error);
        // N·∫øu l·ªói qu√° nhi·ªÅu l·∫ßn, d·ª´ng ki·ªÉm tra
        if (checkCount > 10) {
          clearInterval(checkInterval);
        }
      });
    }
    
    // B·∫Øt ƒë·∫ßu check m·ªói 2 gi√¢y
    checkInterval = setInterval(checkRegenerateStatus, 2000);
    {% endif %}
  </script>
{% endblock %}
