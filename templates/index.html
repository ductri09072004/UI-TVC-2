{% extends "base.html" %}
{% block content %}
<div class="mx-auto max-w-[1800px] px-6 py-6 grid lg:grid-cols-[1fr,2fr] gap-6">
  <!-- Left Panel: Input and Configuration -->
  <div class="space-y-6">
    <!-- Video Upload Area -->
    <div class="bg-slate-800/60 backdrop-blur rounded-xl border border-slate-700/50 p-6">
      <form method="post" enctype="multipart/form-data" action="{{ url_for('upload') }}" id="uploadForm" class="space-y-4">
        <!-- Video URL Input -->
        <div>
          <label class="text-sm font-semibold text-slate-300 mb-2 block">Hoặc nhập URL video</label>
          <input type="url" id="video_url" name="video_url" placeholder="https://example.com/video.mp4" 
                 class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
          <p class="text-xs text-slate-400 mt-1">Hỗ trợ: http, https</p>
        </div>
        
        <div class="text-center text-slate-400 text-sm">HOẶC</div>
        
        <div id="dropzone" class="border-2 border-dashed border-slate-600 rounded-xl p-12 text-center hover:border-purple-500/50 transition cursor-pointer">
          <input type="file" id="video" name="video" accept="video/*" class="hidden" />
          <svg class="w-12 h-12 mx-auto mb-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <p class="text-slate-300 mb-3">Kéo thả video vào đây hoặc</p>
          <button type="button" id="browseBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg transition">
            Chọn file
          </button>
          <p class="text-xs text-slate-400 mt-4">Hỗ trợ: MP4, MKV - tối đa 2 giờ . < 4GB</p>
          <div id="fileInfo" class="mt-3 text-xs text-slate-400"></div>
        </div>

        <!-- Caption Backend Selection -->
        <div class="space-y-3">
          <div>
            <label class="text-sm font-semibold text-slate-300 mb-2 block">Caption Backend</label>
            <select name="caption_backend" id="caption_backend" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="updateConfigVisibility()">
              <option value="openai">OpenAI (GPT-4o-mini)</option>
              <option value="local">BLIP Fine-tuned (Local)</option>
            </select>
          </div>
        </div>
        
        <!-- OpenAI Configuration (shown when OpenAI is selected) -->
        <div id="openai_config" class="space-y-3">
          <div>
            <label class="text-sm font-semibold text-slate-300 mb-2 block">OpenAI API Key</label>
            <input type="password" id="openai_key" name="openai_key" placeholder="sk-..." 
                   class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <p class="text-xs text-slate-400 mt-1">Để trống nếu đã cấu hình trong openai_config.py hoặc biến môi trường</p>
          </div>
          <div>
            <label class="text-sm font-semibold text-slate-300 mb-2 block">OpenAI Model</label>
            <select name="openai_model" class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
              <option value="">Default (gpt-5)</option>
              <option value="gpt-5">GPT-5</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4o-mini">GPT-4o-mini</option>
              <option value="gpt-4-vision-preview">GPT-4 Vision Preview</option>
            </select>
          </div>
        </div>
        
        <!-- BLIP Fine-tuned Configuration (shown when Local is selected) -->
        <div id="local_config" class="space-y-3" style="display: none;">
          <div>
            <label class="text-sm font-semibold text-slate-300 mb-2 block">BLIP Model Path</label>
            <input type="text" id="hf_model" name="hf_model" placeholder="Để trống để dùng model mặc định" 
                   class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <p class="text-xs text-slate-400 mt-1">Đường dẫn đến thư mục chứa BLIP model đã fine-tune. Để trống để dùng model mặc định.</p>
          </div>
        </div>

        <!-- Start Transcription Button -->
        <button type="submit" id="startBtn" class="w-full bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-semibold px-6 py-4 rounded-lg transition">
          Start transcription
        </button>
      </form>
    </div>
  </div>

  <!-- Right Panel: Previous Results or Transcript Output -->
  <div class="bg-slate-800/60 backdrop-blur rounded-xl border border-slate-700/50 p-6">
    <!-- Navigation Tabs -->
    <div class="flex gap-1 border-b border-slate-700 mb-4">
      <button class="px-4 py-2 text-sm font-medium text-white border-b-2 border-purple-500 pb-2" data-tab="results" onclick="switchTab('results')">
        Previous Results
      </button>
      <button class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white" data-tab="script" onclick="switchTab('script')">
        Script
      </button>
      <button class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white" data-tab="segments" onclick="switchTab('segments')">
        Segments
      </button>
      <button class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white" data-tab="speakers" onclick="switchTab('speakers')">
        Speakers
      </button>
      <button class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white" data-tab="metadata" onclick="switchTab('metadata')">
        Metadata
      </button>
    </div>

    <!-- Previous Results Tab Content -->
    <div id="tab-results" class="tab-content">
      {% if jobs and jobs|length > 0 %}
        <div class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
          {% for job in jobs %}
            <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-600/50 hover:bg-slate-700/50 transition cursor-pointer" onclick="window.location.href='{{ url_for('result', job_id=job.job_id) }}'">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="text-sm font-semibold text-white mb-1">{{ job.job_id[:8] }}...</div>
                  <div class="text-xs text-slate-400">{{ job.count }} frames</div>
                </div>
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center text-slate-400 py-12">
          <p class="text-sm">Chưa có kết quả nào. Hãy tải video và bắt đầu transcription.</p>
        </div>
      {% endif %}
    </div>

    <!-- Script Tab Content -->
    <div id="tab-script" class="tab-content hidden">
      <!-- Search Bar -->
      <div class="mb-4">
        <input type="text" id="searchTranscript" placeholder="Tìm trong transcript..." class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
      </div>
      <!-- Transcript Content -->
      <div id="transcriptContent" class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
        <div class="text-center text-slate-400 py-12">
          <p class="text-sm">Chưa có transcript. Hãy tải video và bắt đầu transcription.</p>
        </div>
      </div>
    </div>

    <!-- Segments Tab Content -->
    <div id="tab-segments" class="tab-content hidden">
      <div class="text-center text-slate-400 py-12">
        <p class="text-sm">Chưa có segments.</p>
      </div>
    </div>

    <!-- Speakers Tab Content -->
    <div id="tab-speakers" class="tab-content hidden">
      <div class="text-center text-slate-400 py-12">
        <p class="text-sm">Chức năng đang phát triển.</p>
      </div>
    </div>

    <!-- Metadata Tab Content -->
    <div id="tab-metadata" class="tab-content hidden">
      <div class="text-center text-slate-400 py-12">
        <p class="text-sm">Chưa có metadata.</p>
      </div>
    </div>
  </div>
</div>

<script>
  // File upload handling
  const dropzone = document.getElementById('dropzone');
  const input = document.getElementById('video');
  const browseBtn = document.getElementById('browseBtn');
  const fileInfo = document.getElementById('fileInfo');
  const startBtn = document.getElementById('startBtn');

  const setFileInfo = (file) => {
    if (file) {
      fileInfo.textContent = `${file.name} • ${(file.size/1024/1024).toFixed(2)} MB`;
      startBtn.disabled = false;
      startBtn.classList.remove('disabled:bg-slate-800', 'disabled:text-slate-500');
    } else {
      fileInfo.textContent = '';
      startBtn.disabled = true;
    }
  };

  browseBtn.addEventListener('click', () => input.click());
  
  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('border-purple-500');
  });
  
  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('border-purple-500');
  });
  
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('border-purple-500');
    const files = e.dataTransfer.files;
    if (files && files.length > 0) {
      input.files = files;
      setFileInfo(files[0]);
    }
  });
  
  input.addEventListener('change', () => setFileInfo(input.files[0]));

  // Form validation: require either URL or file
  const uploadForm = document.getElementById('uploadForm');
  const videoUrlInput = document.getElementById('video_url');

  uploadForm.addEventListener('submit', (e) => {
    const hasUrl = videoUrlInput.value.trim() !== '';
    const hasFile = input.files && input.files.length > 0;
    
    if (!hasUrl && !hasFile) {
      e.preventDefault();
      alert('Vui lòng nhập URL video hoặc chọn file video để upload.');
      return false;
    }
    
    // Disable the other input if one is provided
    if (hasUrl) {
      input.removeAttribute('required');
    } else {
      input.setAttribute('required', 'required');
    }
  });

  // Tab switching
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById('tab-' + tabName);
    if (selectedContent) {
      selectedContent.classList.remove('hidden');
    }
    
    // Update tab buttons
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.classList.remove('text-white', 'border-purple-500', 'border-b-2');
      btn.classList.add('text-slate-400');
    });
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
      activeBtn.classList.add('text-white', 'border-purple-500', 'border-b-2');
      activeBtn.classList.remove('text-slate-400');
    }
  }

  // Update configuration visibility based on caption backend selection
  function updateConfigVisibility() {
    const backend = document.getElementById('caption_backend').value;
    const openaiConfig = document.getElementById('openai_config');
    const localConfig = document.getElementById('local_config');
    
    if (backend === 'openai') {
      openaiConfig.style.display = 'block';
      localConfig.style.display = 'none';
    } else {
      openaiConfig.style.display = 'none';
      localConfig.style.display = 'block';
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    updateConfigVisibility();
  });
</script>
{% endblock %}
